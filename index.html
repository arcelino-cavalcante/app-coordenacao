<!DOCTYPE html>
<html lang="pt-BR" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta do Coordenador</title>

    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="manifest" href="/manifest.json">

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
            /* Desabilita a seleção de texto */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .view {
            display: none;
        }

        .view.active {
            display: flex;
            /* Usar flex para que o container da view se comporte como flex container */
        }

        /* Animação para o modal */
        .modal-enter {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Barra de rolagem customizada */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Esconde o app até o firebase carregar */
        #app-container,
        #selection-container {
            display: none;
        }

        #app-container.active,
        #selection-container.active {
            display: flex;
        }

        /* Estilo para o seletor de cor */
        input[type="radio"]:checked+label {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px white, 0 0 0 5px var(--tw-ring-color);
        }

        /* Opções da mensagem */
        .message-bubble .message-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .message-bubble:hover .message-actions {
            opacity: 1;
        }

        /* Camada de segurança para dificultar print screen */
        @media print {
            body {
                display: none !important;
            }
        }

        .secure-overlay::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: transparent;
            pointer-events: none;
            z-index: 9999;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 secure-overlay h-full overflow-hidden">

    <!-- Tela de Seleção de Usuário -->
    <div id="selection-container" class="h-full w-full flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg modal-enter">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-2">Quem está acessando?</h2>
            <p class="text-center text-slate-500 mb-6">Selecione seu perfil para continuar.</p>
            <div class="flex flex-col gap-4">
                <button onclick="promptForPassword('Coordenação A')"
                    class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Coordenação
                    A</button>
                <button onclick="promptForPassword('Coordenação D')"
                    class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">Coordenação
                    D</button>
                <button onclick="promptForPassword('Coordenação R')"
                    class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors">Coordenação
                    R</button>
            </div>
        </div>
    </div>

    <!-- Container Principal do App -->
    <div id="app-container" class="h-full w-full flex flex-col md:flex-row">

        <!-- Menu Lateral (Desktop) -->
        <nav class="bg-white md:w-64 flex-col justify-start p-4 shadow-lg border-r border-slate-200 hidden md:flex">
            <div class="flex-col items-center flex mb-6 p-4">
                <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-slate-500">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                </div>
                <h3 id="current-user-name" class="font-bold text-lg"></h3>
                <button onclick="logout()"
                    class="mt-2 text-sm text-red-500 hover:text-red-700 font-semibold flex items-center gap-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Sair
                </button>
            </div>

            <button onclick="switchView('chat')"
                class="nav-link flex-row items-center gap-2 p-3 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition-colors flex"
                data-view="chat">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                </svg>
                <span class="text-base font-medium">Chat</span>
            </button>
            <button onclick="switchView('tasks')"
                class="nav-link flex-row items-center gap-2 p-3 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition-colors flex"
                data-view="tasks">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                </svg>
                <span class="text-base font-medium">Tarefas</span>
            </button>
            <button onclick="switchView('agenda')"
                class="nav-link flex-row items-center gap-2 p-3 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition-colors flex"
                data-view="agenda">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                    <line x1="16" x2="16" y1="2" y2="6" />
                    <line x1="8" x2="8" y1="2" y2="6" />
                    <line x1="3" x2="21" y1="10" y2="10" />
                </svg>
                <span class="text-base font-medium">Agenda</span>
            </button>
            <button onclick="switchView('tags')"
                class="nav-link flex-row items-center gap-2 p-3 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition-colors flex"
                data-view="tags">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M12.586 2.586a2 2 0 0 0-2.828 0L2.172 10.172a2 2 0 0 0 0 2.828l7.414 7.414a2 2 0 0 0 2.828 0l7.414-7.414a2 2 0 0 0 0-2.828L12.586 2.586z" />
                    <path d="M9 9h.01" />
                </svg>
                <span class="text-base font-medium">Tags</span>
            </button>
            <button onclick="switchView('settings')"
                class="nav-link flex-row items-center gap-2 p-3 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-blue-600 transition-colors flex"
                data-view="settings">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                    <circle cx="12" cy="12" r="3" />
                </svg>
                <span class="text-base font-medium">Ajustes</span>
            </button>
        </nav>

        <!-- Container de Conteúdo (Mobile e Desktop) -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
                <div id="chat-view" class="view flex-col h-full"></div>
                <div id="tasks-view" class="view flex-col h-full"></div>
                <div id="agenda-view" class="view flex-col h-full"></div>
                <div id="tags-view" class="view flex-col h-full"></div>
                <div id="settings-view" class="view flex-col h-full"></div>
            </main>

            <!-- Menu Inferior (Mobile) -->
            <nav class="bg-white flex md:hidden justify-around shadow-lg border-t border-slate-200 flex-shrink-0">
                <button onclick="switchView('chat')"
                    class="nav-link flex-1 flex flex-col items-center gap-1 p-2 text-slate-600" data-view="chat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                    <span class="text-xs font-medium">Chat</span>
                </button>
                <button onclick="switchView('tasks')"
                    class="nav-link flex-1 flex flex-col items-center gap-1 p-2 text-slate-600" data-view="tasks">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    <span class="text-xs font-medium">Tarefas</span>
                </button>
                <button onclick="switchView('agenda')"
                    class="nav-link flex-1 flex flex-col items-center gap-1 p-2 text-slate-600" data-view="agenda">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                        <line x1="16" x2="16" y1="2" y2="6" />
                        <line x1="8" x2="8" y1="2" y2="6" />
                        <line x1="3" x2="21" y1="10" y2="10" />
                    </svg>
                    <span class="text-xs font-medium">Agenda</span>
                </button>
                <button onclick="switchView('tags')"
                    class="nav-link flex-1 flex flex-col items-center gap-1 p-2 text-slate-600" data-view="tags">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.586 2.586a2 2 0 0 0-2.828 0L2.172 10.172a2 2 0 0 0 0 2.828l7.414 7.414a2 2 0 0 0 2.828 0l7.414-7.414a2 2 0 0 0 0-2.828L12.586 2.586z" />
                        <path d="M9 9h.01" />
                    </svg>
                    <span class="text-xs font-medium">Tags</span>
                </button>
                <button onclick="switchView('settings')"
                    class="nav-link flex-1 flex flex-col items-center gap-1 p-2 text-slate-600" data-view="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    <span class="text-xs font-medium">Ajustes</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container"></div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDocs, setDoc, writeBatch, arrayUnion, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // CONFIGURAÇÃO E ESTADO GLOBAL
        // ===================================================================================

        const firebaseConfig = {
            apiKey: "AIzaSyAFciMdd2PXW0nQBwxe53m6l0s1VH2HInQ",
            authDomain: "app-coordenacao.firebaseapp.com",
            projectId: "app-coordenacao",
            storageBucket: "app-coordenacao.appspot.com",
            messagingSenderId: "149476517818",
            appId: "1:149476517818:web:433463bdc40b0d1c415f83"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const state = {
            currentUser: null,
            authReady: false,
            currentView: 'chat',
            chatMode: 'general', // 'general' or 'private'
            privateChatPartner: null,
            messages: [],
            tasks: [],
            events: [],
            tags: [],
            taskSearchTerm: '',
            unreadChats: [], // Nomes dos parceiros com mensagens não lidas
        };

        let unsubscribeMessages = () => { }; // Função para parar de ouvir o chat atual

        let newMessageAttachments = {
            tags: [],
            linkedTask: null,
            linkedEvent: null,
        };

        let newMessageReply = null;

        const tagColors = {
            red: { bg: 'bg-red-200', text: 'text-red-800', ring: 'ring-red-500' },
            orange: { bg: 'bg-orange-200', text: 'text-orange-800', ring: 'ring-orange-500' },
            yellow: { bg: 'bg-yellow-200', text: 'text-yellow-800', ring: 'ring-yellow-500' },
            green: { bg: 'bg-green-200', text: 'text-green-800', ring: 'ring-green-500' },
            teal: { bg: 'bg-teal-200', text: 'text-teal-800', ring: 'ring-teal-500' },
            blue: { bg: 'bg-blue-200', text: 'text-blue-800', ring: 'ring-blue-500' },
            indigo: { bg: 'bg-indigo-200', text: 'text-indigo-800', ring: 'ring-indigo-500' },
            purple: { bg: 'bg-purple-200', text: 'text-purple-800', ring: 'ring-purple-500' },
            pink: { bg: 'bg-pink-200', text: 'text-pink-800', ring: 'ring-pink-500' },
            gray: { bg: 'bg-slate-200', text: 'text-slate-800', ring: 'ring-slate-500' },
        };

        const priorityStyles = {
            'Alta': { border: 'border-red-500', text: 'text-red-600', bg: 'bg-red-100' },
            'Média': { border: 'border-yellow-500', text: 'text-yellow-600', bg: 'bg-yellow-100' },
            'Baixa': { border: 'border-blue-500', text: 'text-blue-600', bg: 'bg-blue-100' },
        };

        // ===================================================================================
        // INICIALIZAÇÃO E AUTENTICAÇÃO
        // ===================================================================================

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.authReady = true;
                await checkForMessageCleanup();
                const loggedInUser = sessionStorage.getItem('coordenacaoUser');
                if (loggedInUser) {
                    state.currentUser = loggedInUser;
                    await checkForUnreadMessages();
                    setupApp();
                } else {
                    document.getElementById('selection-container').classList.add('active');
                }
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth error:", error);
                }
            }
        });

        // Bloqueia o menu de contexto (botão direito)
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Bloqueia atalhos de teclado para copiar
        document.addEventListener('keydown', e => {
            if (e.ctrlKey || e.metaKey) { // Ctrl no Windows, Cmd no Mac
                if (['c', 'x', 'u'].includes(e.key.toLowerCase())) {
                    e.preventDefault();
                }
            }
        });

        window.promptForPassword = (coordinatorName) => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
            <div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm modal-enter">
                    <h3 class="text-xl font-bold mb-2 text-center">Login - ${coordinatorName}</h3>
                    <p class="text-slate-500 text-center mb-4">Digite sua senha para continuar.</p>
                    <form id="password-form">
                        <div class="mb-4">
                            <label for="user-password" class="block text-sm font-medium text-slate-700 mb-1">Senha</label>
                            <input type="password" id="user-password" class="w-full p-2 border border-slate-300 rounded-md" required>
                        </div>
                        <p id="password-error" class="text-red-500 text-sm text-center mb-4"></p>
                        <div class="flex gap-3">
                           <button type="button" onclick="closeModal()" class="w-full bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                           <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Entrar</button>
                        </div>
                    </form>
                </div>
            </div>`;

            document.getElementById('password-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin(coordinatorName);
            });
        };

        window.closeModal = () => {
            document.getElementById('modal-container').innerHTML = '';
        };

        async function handleLogin(coordinatorName) {
            if (!state.authReady) {
                console.error("Firebase auth not ready");
                return;
            }
            const passwordInput = document.getElementById('user-password');
            const errorP = document.getElementById('password-error');
            const enteredPassword = passwordInput.value;
            errorP.textContent = '';

            try {
                const userDocRef = doc(db, "users", coordinatorName);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const correctPassword = userDoc.data().password;
                    if (enteredPassword === correctPassword) {
                        state.currentUser = coordinatorName;
                        sessionStorage.setItem('coordenacaoUser', coordinatorName);
                        closeModal();
                        await checkForUnreadMessages();
                        setupApp();
                    } else {
                        errorP.textContent = 'Senha incorreta.';
                    }
                } else {
                    errorP.textContent = 'Usuário não encontrado. Contate o administrador.';
                    console.error(`Document for ${coordinatorName} does not exist in 'users' collection.`);
                }
            } catch (error) {
                console.error("Login verification error:", error);
                errorP.textContent = 'Erro ao verificar a senha.';
            }
        }

        window.logout = () => {
            sessionStorage.removeItem('coordenacaoUser');
            location.reload();
        };

        function setupApp() {
            document.getElementById('selection-container').classList.remove('active');
            document.getElementById('app-container').classList.add('active');
            document.getElementById('current-user-name').textContent = state.currentUser;
            setupFirestoreListeners();
            switchView(localStorage.getItem('coordenacaoView') || 'chat');
        }

        // ===================================================================================
        // LISTENERS DO FIRESTORE
        // ===================================================================================

        function setupFirestoreListeners() {
            // Cancelar listener anterior
            unsubscribeMessages();

            let messagesQuery;
            if (state.chatMode === 'private') {
                const chatId = [state.currentUser, state.privateChatPartner].sort().join('_');
                messagesQuery = query(collection(db, "private_chats", chatId, "messages"), orderBy("timestamp", "asc"));
            } else {
                messagesQuery = query(collection(db, "messages"), orderBy("timestamp", "asc"));
            }

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                state.messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentView === 'chat') renderChatView();
            });

            // Listeners que não mudam
            onSnapshot(query(collection(db, "tasks")), (snapshot) => {
                state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentView === 'tasks') renderTasksView();
            });

            onSnapshot(query(collection(db, "agenda")), (snapshot) => {
                state.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentView === 'agenda') renderAgendaView();
            });

            onSnapshot(query(collection(db, "tags"), orderBy("name", "asc")), (snapshot) => {
                state.tags = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.currentView === 'tags') renderTagsView();
            });
        }

        // ===================================================================================
        // RENDERIZAÇÃO E TROCA DE VIEWS
        // ===================================================================================

        window.switchView = (viewName) => {
            state.currentView = viewName;
            localStorage.setItem('coordenacaoView', viewName);

            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));

            switch (viewName) {
                case 'chat': renderChatView(); break;
                case 'tasks': renderTasksView(); break;
                case 'agenda': renderAgendaView(); break;
                case 'tags': renderTagsView(); break;
                case 'settings': renderSettingsView(); break;
            }

            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) targetView.classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-blue-600', 'bg-slate-100');
                if (link.dataset.view === viewName) {
                    link.classList.add('text-blue-600', 'bg-slate-100');
                }
            });
        }

        function formatDateTime(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
        }
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
        }

        // --- RENDER CHAT ---
        function renderChatView() {
            const view = document.getElementById('chat-view');
            let headerHTML = '';
            if (state.chatMode === 'private') {
                headerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Conversa com ${state.privateChatPartner}</h2>
                    <button onclick="switchToGeneralChat()" class="text-sm bg-slate-200 px-3 py-1 rounded-lg hover:bg-slate-300">Voltar ao Chat Geral</button>
                </div>`;
            } else {
                const hasAnyUnread = state.unreadChats && state.unreadChats.length > 0;
                const unreadIndicator = hasAnyUnread ? `<span class="w-2 h-2 bg-red-500 rounded-full absolute top-1 right-1"></span>` : '';
                headerHTML = `
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold">Chat Secreto (Todos)</h2>
                    <button onclick="openPrivateChatSelectionModal()" class="relative text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200">
                        Conversa Individual
                        ${unreadIndicator}
                    </button>
                </div>`;
            }

            view.innerHTML = `
            <header class="p-4 bg-white border-b border-slate-200 flex-shrink-0">${headerHTML}</header>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 custom-scrollbar">
                ${state.messages.map(msg => {
                const isCurrentUser = msg.sender === state.currentUser;
                const replyHTML = msg.replyTo ? `<div class="p-2 rounded-lg mb-2 border-l-2 ${isCurrentUser ? 'bg-blue-500 border-blue-300' : 'bg-slate-100 border-slate-300'}"><p class="font-bold text-sm ${isCurrentUser ? 'text-blue-200' : 'text-slate-500'}">${msg.replyTo.sender}</p><p class="text-sm opacity-80 truncate">${msg.replyTo.text}</p></div>` : '';
                const tagsHTML = (msg.tags && msg.tags.length > 0) ? `<div class="flex flex-wrap gap-2 mt-2">${msg.tags.map(tagData => { const colorClasses = tagColors[tagData.color] || tagColors.gray; return `<span class="text-xs ${colorClasses.bg} ${colorClasses.text} font-semibold px-2 py-1 rounded-full">${tagData.name}</span>` }).join('')}</div>` : '';
                const taskHTML = msg.linkedTask ? `<div class="mt-2 p-2 rounded-lg border ${isCurrentUser ? 'bg-blue-700 border-blue-500' : 'bg-slate-50 border-slate-200'}"><p class="text-xs font-semibold ${isCurrentUser ? 'text-blue-200' : 'text-slate-500'}">TAREFA VINCULADA</p><p class="text-sm ${isCurrentUser ? 'text-white' : 'text-slate-700'}">${msg.linkedTask.description}</p></div>` : '';
                const eventHTML = msg.linkedEvent ? `<div class="mt-2 p-2 rounded-lg border ${isCurrentUser ? 'bg-blue-700 border-blue-500' : 'bg-slate-50 border-slate-200'}"><p class="text-xs font-semibold ${isCurrentUser ? 'text-blue-200' : 'text-slate-500'}">EVENTO VINCULADO</p><p class="text-sm ${isCurrentUser ? 'text-white' : 'text-slate-700'}">${msg.linkedEvent.title}</p></div>` : '';

                return `
                    <div class="flex items-start gap-2 ${isCurrentUser ? 'justify-end' : ''}">
                        <div class="relative group message-bubble max-w-xs md:max-w-md p-3 rounded-2xl ${isCurrentUser ? 'bg-blue-600 text-white' : 'bg-white text-slate-800 shadow-sm'}">
                            <button onclick="openMessageActions('${msg.id}')" class="message-actions absolute top-0 ${isCurrentUser ? '-left-8' : '-right-8'} p-1 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                            </button>
                            ${replyHTML}
                            <p class="font-bold text-sm mb-1 ${isCurrentUser ? 'text-blue-200' : 'text-teal-600'}">${msg.sender}</p>
                            ${msg.text ? `<p class="${isCurrentUser ? 'text-white' : 'text-slate-800'}">${msg.text}</p>` : ''}
                            ${taskHTML} ${eventHTML} ${tagsHTML}
                            <p class="text-xs mt-2 text-right opacity-75 ${isCurrentUser ? 'text-blue-200' : 'text-slate-500'}">${formatDateTime(msg.timestamp)}</p>
                        </div>
                    </div>`;
            }).join('')}
            </div>
            <div id="chat-input-area" class="bg-white border-t border-slate-200 flex-shrink-0">
                <div id="reply-preview" class="p-2 bg-slate-100 border-b border-slate-200" style="display: none;"></div>
                <div id="attachments-preview" class="p-2 bg-slate-100" style="display: none;"></div>
                <div class="p-4">
                    <div class="flex gap-2">
                        <button id="attach-btn" class="p-3 border border-slate-300 rounded-lg hover:bg-slate-100">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                        </button>
                        <input type="text" id="message-input" class="flex-1 p-3 border border-slate-300 rounded-lg" placeholder="Digite sua mensagem...">
                        <button id="send-message-btn" class="bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700">Enviar</button>
                    </div>
                </div>
            </div>`;

            document.getElementById('send-message-btn').onclick = sendMessage;
            document.getElementById('attach-btn').onclick = openAttachmentMenu;
            document.getElementById('message-input').onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
            const messagesContainer = view.querySelector('#chat-messages');
            if (messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;
            updateAttachmentsPreview();
            updateReplyPreview();
        }

        function renderTasksView() {
            const view = document.getElementById('tasks-view');

            const filteredTasks = state.tasks.filter(task =>
                task.description.toLowerCase().includes(state.taskSearchTerm.toLowerCase())
            );

            const sortedTasks = [...filteredTasks].sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                const priorityOrder = { 'Alta': 1, 'Média': 2, 'Baixa': 3 };
                return (priorityOrder[a.priority] || 3) - (priorityOrder[b.priority] || 3);
            });

            view.innerHTML = `
            <header class="p-4 bg-white border-b border-slate-200 flex justify-between items-center flex-wrap gap-4 flex-shrink-0">
                <h2 class="text-xl font-bold">Tarefas Compartilhadas</h2>
                <button onclick="openTaskModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>Nova Tarefa</span>
                </button>
                <div class="w-full">
                    <input type="text" id="task-search-input" class="w-full p-2 border border-slate-300 rounded-md" placeholder="Pesquisar tarefas..." value="${state.taskSearchTerm}">
                </div>
            </header>
            <div id="task-list" class="flex-1 p-4 overflow-y-auto space-y-3 custom-scrollbar">
                ${sortedTasks.length === 0 ? `<div class="text-center text-slate-500 mt-8"><p>Nenhuma tarefa encontrada.</p></div>` :
                    sortedTasks.map(task => {
                        const isCompleted = task.completed;
                        const style = priorityStyles[task.priority] || { border: 'border-slate-500', text: 'text-slate-600', bg: 'bg-slate-100' };
                        return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${isCompleted ? 'border-green-500 opacity-70' : style.border}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-semibold ${isCompleted ? 'line-through text-slate-500' : ''}">${task.description}</p>
                                <div class="text-sm text-slate-500 mt-2 flex items-center gap-4 flex-wrap">
                                    <span class="flex items-center gap-1.5">Prazo: ${formatDate(task.deadline)}</span>
                                    <span class="font-semibold px-2 py-0.5 rounded-full ${style.bg} ${style.text}">${task.priority || 'Sem prioridade'}</span>
                                </div>
                                <div class="text-xs text-slate-400 mt-2 border-t pt-2">
                                    Criado por: <span class="font-medium">${task.createdBy || 'Desconhecido'}</span>
                                    ${isCompleted && task.completedBy ? `| Concluído por: <span class="font-medium">${task.completedBy}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                <button onclick="toggleTaskStatus('${task.id}', ${task.completed})" class="p-2 rounded-full hover:bg-slate-100 transition-colors">${isCompleted ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><circle cx="12" cy="12" r="10"/></svg>'}</button>
                                <button onclick="openTaskModal('${task.id}')" class="p-2 rounded-full hover:bg-slate-100 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button>
                                <button onclick="deleteTask('${task.id}')" class="p-2 rounded-full hover:bg-slate-100 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                            </div>
                        </div>
                    </div>`;
                    }).join('')}
            </div>`;

            document.getElementById('task-search-input').oninput = (e) => {
                state.taskSearchTerm = e.target.value;
                renderTasksView();
            };
        }

        function renderAgendaView() {
            const view = document.getElementById('agenda-view');
            const sortedEvents = [...state.events].sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));

            view.innerHTML = `
            <header class="p-4 bg-white border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">Agenda Compartilhada</h2>
                <button onclick="openEventModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>Novo Evento</span>
                </button>
            </header>
            <div id="event-list" class="flex-1 p-4 overflow-y-auto space-y-3 custom-scrollbar">
                ${sortedEvents.length === 0 ? `<div class="text-center text-slate-500 mt-8"><p>Nenhum evento na agenda.</p></div>` :
                    sortedEvents.map(event => {
                        const eventDate = new Date(event.dateTime);
                        const day = String(eventDate.getDate()).padStart(2, '0');
                        const month = eventDate.toLocaleString('pt-BR', { month: 'short' }).replace('.', '');
                        return `
                    <div class="bg-white p-4 rounded-lg shadow-sm flex gap-4 items-start">
                        <div class="flex-shrink-0 text-center bg-slate-100 p-3 rounded-lg w-20">
                            <p class="text-2xl font-bold text-blue-600">${day}</p>
                            <p class="text-sm font-semibold uppercase text-slate-600">${month}</p>
                        </div>
                        <div class="flex-1">
                             <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg">${event.title}</h4>
                                    <p class="text-sm text-slate-500">${String(eventDate.getHours()).padStart(2, '0')}:${String(eventDate.getMinutes()).padStart(2, '0')}</p>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button onclick="openEventModal('${event.id}')" class="p-2 rounded-full hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg></button>
                                    <button onclick="deleteEvent('${event.id}')" class="p-2 rounded-full hover:bg-slate-100"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                                </div>
                            </div>
                            <p class="text-slate-600 mt-2">${event.description || ''}</p>
                        </div>
                    </div>`;
                    }).join('')}
            </div>`;
        }

        function renderTagsView() {
            const view = document.getElementById('tags-view');
            view.innerHTML = `
            <header class="p-4 bg-white border-b border-slate-200 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">Gerenciar Tags</h2>
                <button onclick="openCreateTagModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Nova Tag</button>
            </header>
            <div class="flex-1 p-4 overflow-y-auto custom-scrollbar">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                ${state.tags.length === 0 ? `<div class="col-span-full text-center text-slate-500 mt-8"><p>Nenhuma tag criada.</p></div>` :
                    state.tags.map(tag => {
                        const colorClasses = tagColors[tag.color] || tagColors.gray;
                        return `
                    <div class="bg-white p-4 rounded-lg shadow-sm flex flex-col items-center justify-center text-center">
                        <span class="font-semibold px-3 py-1 rounded-full ${colorClasses.bg} ${colorClasses.text}">${tag.name}</span>
                        <div class="flex items-center gap-2 mt-4">
                            <button onclick="openCreateTagModal('${tag.id}')" class="p-2 rounded-full hover:bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                            </button>
                            <button onclick="deleteTag('${tag.id}')" class="p-2 rounded-full hover:bg-slate-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderSettingsView() {
            const view = document.getElementById('settings-view');
            view.innerHTML = `
            <header class="p-4 bg-white border-b border-slate-200 flex-shrink-0"><h2 class="text-xl font-bold">Ajustes da Conta</h2></header>
            <div class="flex-1 p-4 md:p-6 overflow-y-auto custom-scrollbar">
                <div class="max-w-lg mx-auto space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold mb-4">Alterar Senha de ${state.currentUser}</h3>
                        <form id="update-password-form">
                            <div class="mb-4">
                                <label for="current-password" class="block text-sm font-medium text-slate-700 mb-1">Senha Atual</label>
                                <input type="password" id="current-password" class="w-full p-2 border border-slate-300 rounded-md" required>
                            </div>
                            <div class="mb-4">
                                <label for="new-password" class="block text-sm font-medium text-slate-700 mb-1">Nova Senha</label>
                                <input type="password" id="new-password" class="w-full p-2 border border-slate-300 rounded-md" required>
                            </div>
                             <p id="update-password-message" class="text-sm mb-4"></p>
                            <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar Nova Senha</button>
                        </form>
                    </div>
                </div>
            </div>`;

            document.getElementById('update-password-form').addEventListener('submit', handleUpdatePassword);
        }

        // ===================================================================================
        // AÇÕES E MODAIS
        // ===================================================================================

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text && newMessageAttachments.tags.length === 0 && !newMessageAttachments.linkedTask && !newMessageAttachments.linkedEvent && !newMessageReply) {
                return;
            }

            let messageCollectionRef;
            if (state.chatMode === 'private') {
                const chatId = [state.currentUser, state.privateChatPartner].sort().join('_');
                messageCollectionRef = collection(db, "private_chats", chatId, "messages");
            } else {
                messageCollectionRef = collection(db, "messages");
            }

            const messageData = {
                sender: state.currentUser,
                text: text,
                timestamp: serverTimestamp(),
                ...newMessageAttachments,
                replyTo: newMessageReply,
            };

            if (state.chatMode === 'private') {
                messageData.readBy = [state.currentUser];
            }

            await addDoc(messageCollectionRef, messageData);

            input.value = '';
            newMessageAttachments = { tags: [], linkedTask: null, linkedEvent: null };
            newMessageReply = null;
            updateAttachmentsPreview();
            updateReplyPreview();
        }

        function openAttachmentMenu() {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
            <div id="attachment-menu-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs modal-enter">
                    <h3 class="text-lg font-bold mb-4 text-center">Anexar à Mensagem</h3>
                    <div class="flex flex-col gap-3">
                        <button onclick="openTagSelectionModal()" class="w-full text-left p-3 hover:bg-slate-100 rounded-lg">Adicionar Tag</button>
                        <button onclick="openTaskSelectionModal()" class="w-full text-left p-3 hover:bg-slate-100 rounded-lg">Anexar Tarefa</button>
                        <button onclick="openEventSelectionModal()" class="w-full text-left p-3 hover:bg-slate-100 rounded-lg">Anexar Evento</button>
                        <button onclick="closeModal()" class="mt-2 w-full text-center p-2 bg-slate-200 rounded-lg">Cancelar</button>
                    </div>
                </div>
            </div>`;
        }

        window.openTagSelectionModal = () => {
            closeModal();
            const modalContainer = document.getElementById('modal-container');

            let tagListHTML = state.tags.length > 0
                ? state.tags.map(tag => {
                    const colorClasses = tagColors[tag.color] || tagColors.gray;
                    return `<li onclick="selectTagForMessage('${tag.id}')" class="p-3 hover:bg-slate-100 rounded-lg cursor-pointer flex items-center gap-2">
                            <span class="w-4 h-4 rounded-full ${colorClasses.bg}"></span>
                            <span>${tag.name}</span>
                        </li>`
                }).join('')
                : `<li class="p-3 text-slate-500">Nenhuma tag criada. Vá para a tela de Tags para criar uma.</li>`;

            modalContainer.innerHTML = `
            <div id="tag-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-enter">
                    <h3 class="text-lg font-bold mb-4">Selecionar Tag</h3>
                    <ul class="max-h-60 overflow-y-auto custom-scrollbar">${tagListHTML}</ul>
                    <button onclick="closeModal()" class="mt-4 w-full text-center p-2 bg-slate-200 rounded-lg">Fechar</button>
                </div>
            </div>`;
        }

        window.selectTagForMessage = (tagId) => {
            const tag = state.tags.find(t => t.id === tagId);
            if (tag && !newMessageAttachments.tags.some(t => t.id === tagId)) {
                newMessageAttachments.tags.push({ id: tag.id, name: tag.name, color: tag.color });
                updateAttachmentsPreview();
            }
            closeModal();
        }

        async function handleUpdatePassword(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const messageP = document.getElementById('update-password-message');
            messageP.textContent = '';

            if (!state.currentUser) return;

            const userDocRef = doc(db, "users", state.currentUser);

            try {
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().password === currentPassword) {
                    await updateDoc(userDocRef, { password: newPassword });
                    messageP.textContent = 'Senha atualizada com sucesso!';
                    messageP.className = 'text-green-600 text-sm mb-4';
                    e.target.reset();
                } else {
                    messageP.textContent = 'A senha atual está incorreta.';
                    messageP.className = 'text-red-600 text-sm mb-4';
                }
            } catch (error) {
                console.error("Update password error:", error);
                messageP.textContent = 'Ocorreu um erro ao tentar atualizar a senha.';
                messageP.className = 'text-red-600 text-sm mb-4';
            }
        }

        function updateAttachmentsPreview() {
            const previewContainer = document.getElementById('attachments-preview');
            if (!previewContainer) return;

            let previewHTML = '';
            if (newMessageAttachments.tags.length > 0) {
                previewHTML += newMessageAttachments.tags.map(tag => {
                    const colorClasses = tagColors[tag.color] || tagColors.gray;
                    return `<span class="text-xs ${colorClasses.bg} ${colorClasses.text} font-semibold px-2 py-1 rounded-full mr-1">${tag.name}</span>`
                }).join('');
            }
            if (newMessageAttachments.linkedTask) {
                previewHTML += `<span class="text-sm p-1 bg-slate-200 rounded">Tarefa: ${newMessageAttachments.linkedTask.description}</span>`;
            }
            if (newMessageAttachments.linkedEvent) {
                previewHTML += `<span class="text-sm p-1 bg-slate-200 rounded">Evento: ${newMessageAttachments.linkedEvent.title}</span>`;
            }

            if (previewHTML) {
                previewContainer.innerHTML = previewHTML + `<button onclick="clearAttachments()" class="ml-2 text-red-500 font-bold">X</button>`;
                previewContainer.style.display = 'block';
            } else {
                previewContainer.innerHTML = '';
                previewContainer.style.display = 'none';
            }
        }

        window.clearAttachments = () => {
            newMessageAttachments = { tags: [], linkedTask: null, linkedEvent: null };
            updateAttachmentsPreview();
        }

        window.openCreateTagModal = (tagId = null) => {
            const existingTag = tagId ? state.tags.find(t => t.id === tagId) : null;
            const modalContainer = document.getElementById('modal-container');

            const colorOptionsHTML = Object.entries(tagColors).map(([colorName, classes]) => `
            <div>
                <input type="radio" name="tag-color" id="color-${colorName}" value="${colorName}" class="sr-only" ${existingTag?.color === colorName ? 'checked' : ''}>
                <label for="color-${colorName}" style="--tw-ring-color: ${colorName === 'gray' ? '#64748b' : `var(--tw-color-${colorName}-500)`}" class="block w-8 h-8 rounded-full cursor-pointer transition-transform ${classes.bg} ring-offset-2"></label>
            </div>
        `).join('');

            modalContainer.innerHTML = `
            <div id="create-tag-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-enter">
                    <h3 class="text-lg font-bold mb-4">${existingTag ? 'Editar Tag' : 'Criar Nova Tag'}</h3>
                    <form id="create-tag-form">
                        <input type="hidden" id="tag-id" value="${tagId || ''}">
                        <div class="mb-4">
                            <label for="tag-name" class="block text-sm font-medium text-slate-700 mb-1">Nome da Tag</label>
                            <input type="text" id="tag-name" class="w-full p-2 border border-slate-300 rounded-md" required value="${existingTag?.name || ''}">
                        </div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Cor</label>
                            <div class="flex flex-wrap justify-center gap-4">${colorOptionsHTML}</div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeModal()" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>`;

            document.getElementById('create-tag-form').onsubmit = handleTagFormSubmit;
        }

        async function handleTagFormSubmit(e) {
            e.preventDefault();
            const tagId = document.getElementById('tag-id').value;
            const tagName = document.getElementById('tag-name').value.trim();
            const selectedColor = document.querySelector('input[name="tag-color"]:checked')?.value;

            if (!tagName || !selectedColor) {
                alert('Por favor, preencha o nome e selecione uma cor.');
                return;
            }

            const tagData = { name: tagName, color: selectedColor };

            if (tagId) {
                await updateDoc(doc(db, "tags", tagId), tagData);
            } else {
                await addDoc(collection(db, "tags"), tagData);
            }
            closeModal();
        }

        window.deleteTag = (tagId) => {
            showConfirmModal('Tem certeza que deseja excluir esta tag?', async () => {
                await deleteDoc(doc(db, "tags", tagId));
            });
        }

        window.openTaskModal = (taskId = null) => {
            const modalContainer = document.getElementById('modal-container');
            const task = taskId ? state.tasks.find(t => t.id === taskId) : null;
            modalContainer.innerHTML = `
            <div id="task-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-40">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-enter">
                    <h3 class="text-xl font-bold mb-4">${task ? 'Editar Tarefa' : 'Nova Tarefa'}</h3>
                    <form id="task-form">
                        <input type="hidden" id="task-id" value="${task?.id || ''}">
                        <div class="mb-4">
                            <label for="task-description" class="block text-sm font-medium text-slate-700 mb-1">Descrição</label>
                            <input type="text" id="task-description" class="w-full p-2 border border-slate-300 rounded-md" required value="${task?.description || ''}">
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="task-deadline" class="block text-sm font-medium text-slate-700 mb-1">Prazo</label>
                                <input type="date" id="task-deadline" class="w-full p-2 border border-slate-300 rounded-md" required value="${task ? new Date(task.deadline).toISOString().split('T')[0] : ''}">
                            </div>
                            <div>
                                <label for="task-priority" class="block text-sm font-medium text-slate-700 mb-1">Prioridade</label>
                                <select id="task-priority" class="w-full p-2 border border-slate-300 rounded-md">
                                    <option value="Baixa" ${task?.priority === 'Baixa' ? 'selected' : ''}>Baixa</option>
                                    <option value="Média" ${!task || task?.priority === 'Média' ? 'selected' : ''}>Média</option>
                                    <option value="Alta" ${task?.priority === 'Alta' ? 'selected' : ''}>Alta</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeModal()" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>`;

            document.getElementById('task-form').onsubmit = handleTaskFormSubmit;
        }

        async function handleTaskFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('task-id').value;
            const description = document.getElementById('task-description').value;
            const deadline = document.getElementById('task-deadline').value;
            const priority = document.getElementById('task-priority').value;

            const data = {
                description,
                deadline: new Date(deadline).toISOString().split('T')[0] + 'T23:59:59.999Z',
                priority,
            };

            if (id) {
                await updateDoc(doc(db, "tasks", id), data);
            } else {
                data.completed = false;
                data.createdAt = serverTimestamp();
                data.createdBy = state.currentUser;
                await addDoc(collection(db, "tasks"), data);
            }
            closeModal();
        }

        window.deleteTask = (taskId) => {
            showConfirmModal('Tem certeza que deseja excluir esta tarefa?', async () => {
                await deleteDoc(doc(db, "tasks", taskId));
            });
        }

        window.toggleTaskStatus = async (taskId, currentStatus) => {
            const updateData = {
                completed: !currentStatus,
                completedBy: !currentStatus ? state.currentUser : null,
            };
            await updateDoc(doc(db, "tasks", taskId), updateData);
        }

        window.openEventModal = (eventId = null) => {
            const modalContainer = document.getElementById('modal-container');
            const event = eventId ? state.events.find(e => e.id === eventId) : null;
            const eventDate = event ? new Date(event.dateTime) : null;

            modalContainer.innerHTML = `
            <div id="event-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-40">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-enter">
                    <h3 class="text-xl font-bold mb-4">${event ? 'Editar Evento' : 'Novo Evento'}</h3>
                    <form id="event-form">
                        <input type="hidden" id="event-id" value="${event?.id || ''}">
                        <div class="mb-4">
                            <label for="event-title" class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                            <input type="text" id="event-title" class="w-full p-2 border border-slate-300 rounded-md" required value="${event?.title || ''}">
                        </div>
                        <div class="mb-4">
                            <label for="event-description" class="block text-sm font-medium text-slate-700 mb-1">Descrição</label>
                            <textarea id="event-description" rows="3" class="w-full p-2 border border-slate-300 rounded-md">${event?.description || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <label for="event-date" class="block text-sm font-medium text-slate-700 mb-1">Data</label>
                                <input type="date" id="event-date" class="w-full p-2 border border-slate-300 rounded-md" required value="${eventDate ? eventDate.toISOString().split('T')[0] : ''}">
                            </div>
                            <div>
                                <label for="event-time" class="block text-sm font-medium text-slate-700 mb-1">Hora</label>
                                <input type="time" id="event-time" class="w-full p-2 border border-slate-300 rounded-md" required value="${eventDate ? eventDate.toTimeString().slice(0, 5) : ''}">
                            </div>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeModal()" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300">Cancelar</button>
                            <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>`;

            document.getElementById('event-form').onsubmit = handleEventFormSubmit;
        }

        async function handleEventFormSubmit(event) {
            event.preventDefault();
            const id = document.getElementById('event-id').value;
            const title = document.getElementById('event-title').value;
            const description = document.getElementById('event-description').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;

            const data = {
                title,
                description,
                dateTime: new Date(`${date}T${time}`).toISOString()
            };

            if (id) {
                await updateDoc(doc(db, "agenda", id), data);
            } else {
                await addDoc(collection(db, "agenda"), data);
            }
            closeModal();
        }

        window.deleteEvent = (eventId) => {
            showConfirmModal('Tem certeza que deseja excluir este evento?', async () => {
                await deleteDoc(doc(db, "agenda", eventId));
            });
        }

        function showConfirmModal(message, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
            <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm modal-enter text-center">
                    <p class="text-lg mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel" onclick="closeModal()" class="bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg hover:bg-slate-300">Cancelar</button>
                        <button id="confirm-ok" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Confirmar</button>
                    </div>
                </div>
            </div>`;

            document.getElementById('confirm-ok').onclick = () => {
                onConfirm();
                closeModal();
            };
        }

        window.openMessageActions = (messageId) => {
            const msg = state.messages.find(m => m.id === messageId);
            if (!msg) return;

            const modalContainer = document.getElementById('modal-container');
            const canDelete = msg.sender === state.currentUser;

            modalContainer.innerHTML = `
            <div id="message-actions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-2 w-full max-w-xs modal-enter">
                    <ul class="flex flex-col">
                        <li><button onclick="replyToMessage('${msg.id}')" class="w-full text-left p-3 hover:bg-slate-100 rounded-lg">Responder</button></li>
                        ${canDelete ? `<li><button onclick="deleteMessage('${msg.id}')" class="w-full text-left p-3 text-red-600 hover:bg-red-50 rounded-lg">Apagar</button></li>` : ''}
                        <li><button onclick="closeModal()" class="w-full text-left p-3 hover:bg-slate-100 rounded-lg">Cancelar</button></li>
                    </ul>
                </div>
            </div>`;
        }

        window.replyToMessage = (messageId) => {
            const msg = state.messages.find(m => m.id === messageId);
            if (msg) {
                newMessageReply = {
                    id: msg.id,
                    sender: msg.sender,
                    text: msg.text || 'Anexo'
                };
                updateReplyPreview();
            }
            closeModal();
        }

        window.deleteMessage = (messageId) => {
            showConfirmModal('Tem certeza que deseja apagar esta mensagem?', async () => {
                let messageRef;
                if (state.chatMode === 'private') {
                    const chatId = [state.currentUser, state.privateChatPartner].sort().join('_');
                    messageRef = doc(db, "private_chats", chatId, "messages", messageId);
                } else {
                    messageRef = doc(db, "messages", messageId);
                }
                await deleteDoc(messageRef);
            });
        }

        function updateReplyPreview() {
            const previewContainer = document.getElementById('reply-preview');
            if (!previewContainer) return;

            if (newMessageReply) {
                previewContainer.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="border-l-2 border-blue-500 pl-2">
                        <p class="font-bold text-sm text-slate-600">${newMessageReply.sender}</p>
                        <p class="text-sm text-slate-500 truncate">${newMessageReply.text}</p>
                    </div>
                    <button onclick="clearReply()" class="font-bold text-red-500">X</button>
                </div>`;
                previewContainer.style.display = 'block';
            } else {
                previewContainer.innerHTML = '';
                previewContainer.style.display = 'none';
            }
        }

        window.clearReply = () => {
            newMessageReply = null;
            updateReplyPreview();
        }

        async function checkForMessageCleanup() {
            const today = new Date().toLocaleDateString();
            const metaRef = doc(db, "app_meta", "cleanup_tracker");

            try {
                const metaDoc = await getDoc(metaRef);
                let lastCleanup = '';

                if (metaDoc.exists()) {
                    lastCleanup = metaDoc.data().lastCleanupDate;
                } else {
                    await setDoc(metaRef, { lastCleanupDate: today });
                    console.log("Rastreador de limpeza inicializado.");
                    return;
                }

                if (lastCleanup !== today) {
                    console.log("Novo dia detectado, limpando todas as conversas...");

                    // Limpar chat geral
                    const messagesRef = collection(db, "messages");
                    const generalSnapshot = await getDocs(messagesRef);
                    const deletePromises = [];
                    generalSnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));

                    // Limpar chats privados
                    const privateChatsRef = collection(db, "private_chats");
                    const privateChatsSnapshot = await getDocs(privateChatsRef);
                    for (const chatDoc of privateChatsSnapshot.docs) {
                        const privateMessagesRef = collection(db, "private_chats", chatDoc.id, "messages");
                        const privateMessagesSnapshot = await getDocs(privateMessagesRef);
                        privateMessagesSnapshot.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                    }

                    await Promise.all(deletePromises);

                    await updateDoc(metaRef, { lastCleanupDate: today });
                    console.log("Todas as mensagens antigas foram apagadas e data de limpeza atualizada.");
                }
            } catch (error) {
                console.error("Erro no processo de limpeza de mensagens:", error);
            }
        }

        window.openPrivateChatSelectionModal = () => {
            const modalContainer = document.getElementById('modal-container');
            const otherCoordinators = ['Coordenação A', 'Coordenação D', 'Coordenação R'].filter(c => c !== state.currentUser);

            const buttonsHTML = otherCoordinators.map(name => {
                const hasUnread = state.unreadChats.includes(name);
                const unreadIndicator = hasUnread ? `<span class="w-2 h-2 bg-red-500 rounded-full"></span>` : '';
                return `<button onclick="startPrivateChat('${name}')" class="w-full text-left p-3 hover:bg-slate-100 rounded-lg flex items-center justify-between"><span>${name}</span> ${unreadIndicator}</button>`
            }).join('');

            modalContainer.innerHTML = `
            <div id="private-chat-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs modal-enter">
                    <h3 class="text-lg font-bold mb-4 text-center">Iniciar Conversa Com</h3>
                    <div class="flex flex-col gap-2">
                        ${buttonsHTML}
                        <button onclick="closeModal()" class="mt-4 w-full text-center p-2 bg-slate-200 rounded-lg">Cancelar</button>
                    </div>
                </div>
            </div>`;
        }

        window.startPrivateChat = async (partnerName) => {
            state.chatMode = 'private';
            state.privateChatPartner = partnerName;
            state.messages = []; // Limpa mensagens antigas
            await markMessagesAsRead();
            await checkForUnreadMessages(); // Re-checa para remover o indicador
            setupFirestoreListeners(); // Reativa o listener para o chat privado
            closeModal();
            renderChatView(); // Renderiza a view do chat imediatamente
        }

        window.switchToGeneralChat = () => {
            state.chatMode = 'general';
            state.privateChatPartner = null;
            state.messages = []; // Limpa mensagens antigas
            setupFirestoreListeners(); // Reativa o listener para o chat geral
            renderChatView();
        }

        async function checkForUnreadMessages() {
            const otherCoordinators = ['Coordenação A', 'Coordenação D', 'Coordenação R'].filter(c => c !== state.currentUser);
            const unreadFrom = new Set();

            for (const partner of otherCoordinators) {
                const chatId = [state.currentUser, partner].sort().join('_');
                const messagesRef = collection(db, "private_chats", chatId, "messages");
                const q = query(messagesRef, where("sender", "==", partner));

                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if (!msg.readBy || !msg.readBy.includes(state.currentUser)) {
                        unreadFrom.add(partner);
                    }
                });
            }
            state.unreadChats = Array.from(unreadFrom);
        }

        async function markMessagesAsRead() {
            if (state.chatMode !== 'private' || !state.privateChatPartner) return;

            const chatId = [state.currentUser, state.privateChatPartner].sort().join('_');
            const messagesRef = collection(db, "private_chats", chatId, "messages");

            const q = query(messagesRef, where("sender", "==", state.privateChatPartner));

            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            let updatesMade = false;

            snapshot.forEach(docSnapshot => {
                const msg = docSnapshot.data();
                if (!msg.readBy || !msg.readBy.includes(state.currentUser)) {
                    batch.update(docSnapshot.ref, {
                        readBy: arrayUnion(state.currentUser)
                    });
                    updatesMade = true;
                }
            });

            if (updatesMade) {
                await batch.commit();
                console.log("Mensagens marcadas como lidas.");
            }
        }

        window.openTaskSelectionModal = () => {
            closeModal();
            const modalContainer = document.getElementById('modal-container');
            const pendingTasks = state.tasks.filter(t => !t.completed);

            let taskListHTML = pendingTasks.length > 0
                ? pendingTasks.map(task => `<li onclick="selectTask('${task.id}')" class="p-3 hover:bg-slate-100 rounded-lg cursor-pointer">${task.description}</li>`).join('')
                : `<li class="p-3 text-slate-500">Nenhuma tarefa pendente.</li>`;

            modalContainer.innerHTML = `
            <div id="task-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-enter">
                    <h3 class="text-lg font-bold mb-4">Anexar Tarefa Pendente</h3>
                    <ul class="max-h-60 overflow-y-auto custom-scrollbar">${taskListHTML}</ul>
                    <button onclick="closeModal()" class="mt-4 w-full text-center p-2 bg-slate-200 rounded-lg">Cancelar</button>
                </div>
            </div>`;
        }

        window.selectTask = (taskId) => {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                newMessageAttachments.linkedTask = { id: task.id, description: task.description };
                newMessageAttachments.linkedEvent = null; // Só pode ter um ou outro
                updateAttachmentsPreview();
            }
            closeModal();
        }

        window.openEventSelectionModal = () => {
            closeModal();
            const modalContainer = document.getElementById('modal-container');
            const upcomingEvents = state.events.filter(e => new Date(e.dateTime) >= new Date());

            let eventListHTML = upcomingEvents.length > 0
                ? upcomingEvents.map(event => `<li onclick="selectEvent('${event.id}')" class="p-3 hover:bg-slate-100 rounded-lg cursor-pointer">${event.title} (${formatDate(event.dateTime)})</li>`).join('')
                : `<li class="p-3 text-slate-500">Nenhum evento futuro.</li>`;

            modalContainer.innerHTML = `
            <div id="event-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-enter">
                    <h3 class="text-lg font-bold mb-4">Anexar Evento Futuro</h3>
                    <ul class="max-h-60 overflow-y-auto custom-scrollbar">${eventListHTML}</ul>
                    <button onclick="closeModal()" class="mt-4 w-full text-center p-2 bg-slate-200 rounded-lg">Cancelar</button>
                </div>
            </div>`;
        }

        window.selectEvent = (eventId) => {
            const event = state.events.find(e => e.id === eventId);
            if (event) {
                newMessageAttachments.linkedEvent = { id: event.id, title: event.title };
                newMessageAttachments.linkedTask = null; // Só pode ter um ou outro
                updateAttachmentsPreview();
            }
            closeModal();
        }

    </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>

</body>

</html>
